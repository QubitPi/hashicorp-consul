{"pageProps":{"layoutProps":{"breadcrumbLinks":[{"title":"Developer","url":"/"},{"title":"Consul","url":"/consul"},{"title":"API","url":"/consul/api-docs","isCurrentPage":false},{"title":"API Features"},{"title":"Blocking Queries","url":"/consul/api-docs/features/blocking","isCurrentPage":true}],"sidebarNavDataLevels":[{"levelButtonProps":{"levelDownButtonText":"Consul Home"},"menuItems":[{"leadingIconName":"home","title":"HashiCorp Developer","href":"/"},{"leadingIconName":"guide","title":"Tutorials","href":"/tutorials"},{"divider":true},{"heading":"Products"},{"leadingIconName":"hcp","title":"HashiCorp Cloud Platform","href":"/hcp"},{"leadingIconName":"terraform","title":"Terraform","href":"/terraform"},{"leadingIconName":"packer","title":"Packer","href":"/packer"},{"leadingIconName":"consul","title":"Consul","href":"/consul"},{"leadingIconName":"vault","title":"Vault","href":"/vault"},{"leadingIconName":"boundary","title":"Boundary","href":"/boundary"},{"leadingIconName":"nomad","title":"Nomad","href":"/nomad"},{"leadingIconName":"waypoint","title":"Waypoint","href":"/waypoint"},{"leadingIconName":"vagrant","title":"Vagrant","href":"/vagrant"}],"showFilterInput":false,"title":"Main Menu"},{"levelButtonProps":{"levelUpButtonText":"Main Menu","levelDownButtonText":"Previous"},"menuItems":[{"title":"Consul","fullPath":"/consul","theme":"consul"},{"title":"Install","fullPath":"/consul/install"},{"title":"Tutorials","fullPath":"/consul/tutorials"},{"title":"Documentation","fullPath":"/consul/docs"},{"title":"API","fullPath":"/consul/api-docs"},{"title":"CLI","fullPath":"/consul/commands"}],"showFilterInput":false,"title":"Consul","visuallyHideTitle":true},{"backToLinkProps":{"text":"Consul Home","href":"/consul"},"levelButtonProps":{"levelUpButtonText":"Consul Home"},"menuItems":[{"title":"API","fullPath":"/consul/api-docs","theme":"consul"},{"title":"API Structure","path":"api-structure","filePath":"../content/api-docs/api-structure.mdx","fullPath":"/consul/api-docs/api-structure","id":"sidebar-nav-item-0"},{"title":"API Features","routes":[{"title":"Consistency Modes","path":"features/consistency","filePath":"../content/api-docs/features/consistency.mdx","fullPath":"/consul/api-docs/features/consistency","id":"sidebar-nav-item-2"},{"title":"Blocking Queries","path":"features/blocking","filePath":"../content/api-docs/features/blocking.mdx","fullPath":"/consul/api-docs/features/blocking","id":"sidebar-nav-item-3"},{"title":"Filtering","path":"features/filtering","filePath":"../content/api-docs/features/filtering.mdx","fullPath":"/consul/api-docs/features/filtering","id":"sidebar-nav-item-4"},{"title":"Agent Caching","path":"features/caching","filePath":"../content/api-docs/features/caching.mdx","fullPath":"/consul/api-docs/features/caching","id":"sidebar-nav-item-5"}],"id":"sidebar-nav-item-1"},{"divider":true,"id":"sidebar-nav-item-6"},{"title":"ACLs","routes":[{"title":"Overview","path":"acl","filePath":"../content/api-docs/acl/index.mdx","fullPath":"/consul/api-docs/acl","id":"sidebar-nav-item-8"},{"title":"Tokens","path":"acl/tokens","filePath":"../content/api-docs/acl/tokens.mdx","fullPath":"/consul/api-docs/acl/tokens","id":"sidebar-nav-item-9"},{"title":"Policies","path":"acl/policies","filePath":"../content/api-docs/acl/policies.mdx","fullPath":"/consul/api-docs/acl/policies","id":"sidebar-nav-item-10"},{"title":"Templated Policies","path":"acl/templated-policies","filePath":"../content/api-docs/acl/templated-policies.mdx","fullPath":"/consul/api-docs/acl/templated-policies","id":"sidebar-nav-item-11"},{"title":"Roles","path":"acl/roles","filePath":"../content/api-docs/acl/roles.mdx","fullPath":"/consul/api-docs/acl/roles","id":"sidebar-nav-item-12"},{"title":"Auth Methods","path":"acl/auth-methods","filePath":"../content/api-docs/acl/auth-methods.mdx","fullPath":"/consul/api-docs/acl/auth-methods","id":"sidebar-nav-item-13"},{"title":"Binding Rules","path":"acl/binding-rules","filePath":"../content/api-docs/acl/binding-rules.mdx","fullPath":"/consul/api-docs/acl/binding-rules","id":"sidebar-nav-item-14"}],"id":"sidebar-nav-item-7"},{"title":"Admin Partitions","path":"admin-partitions","filePath":"../content/api-docs/admin-partitions.mdx","fullPath":"/consul/api-docs/admin-partitions","id":"sidebar-nav-item-15"},{"title":"Agent","routes":[{"title":"Overview","path":"agent","filePath":"../content/api-docs/agent/index.mdx","fullPath":"/consul/api-docs/agent","id":"sidebar-nav-item-17"},{"title":"Checks","path":"agent/check","filePath":"../content/api-docs/agent/check.mdx","fullPath":"/consul/api-docs/agent/check","id":"sidebar-nav-item-18"},{"title":"Services","path":"agent/service","filePath":"../content/api-docs/agent/service.mdx","fullPath":"/consul/api-docs/agent/service","id":"sidebar-nav-item-19"},{"title":"Connect","path":"agent/connect","filePath":"../content/api-docs/agent/connect.mdx","fullPath":"/consul/api-docs/agent/connect","id":"sidebar-nav-item-20"}],"id":"sidebar-nav-item-16"},{"title":"Catalog","path":"catalog","filePath":"../content/api-docs/catalog.mdx","fullPath":"/consul/api-docs/catalog","id":"sidebar-nav-item-21"},{"title":"Cluster Peering","path":"peering","filePath":"../content/api-docs/peering.mdx","fullPath":"/consul/api-docs/peering","id":"sidebar-nav-item-22"},{"title":"Config","path":"config","filePath":"../content/api-docs/config.mdx","fullPath":"/consul/api-docs/config","id":"sidebar-nav-item-23"},{"title":"Connect","routes":[{"title":"Overview","path":"connect","filePath":"../content/api-docs/connect/index.mdx","fullPath":"/consul/api-docs/connect","id":"sidebar-nav-item-25"},{"title":"Certificate Authority (CA)","path":"connect/ca","filePath":"../content/api-docs/connect/ca.mdx","fullPath":"/consul/api-docs/connect/ca","id":"sidebar-nav-item-26"},{"title":"Intentions","path":"connect/intentions","filePath":"../content/api-docs/connect/intentions.mdx","fullPath":"/consul/api-docs/connect/intentions","id":"sidebar-nav-item-27"}],"id":"sidebar-nav-item-24"},{"title":"Coordinates","path":"coordinate","filePath":"../content/api-docs/coordinate.mdx","fullPath":"/consul/api-docs/coordinate","id":"sidebar-nav-item-28"},{"title":"Discovery Chain","path":"discovery-chain","filePath":"../content/api-docs/discovery-chain.mdx","fullPath":"/consul/api-docs/discovery-chain","id":"sidebar-nav-item-29"},{"title":"Events","path":"event","filePath":"../content/api-docs/event.mdx","fullPath":"/consul/api-docs/event","id":"sidebar-nav-item-30"},{"title":"Exported Services","path":"exported-services","filePath":"../content/api-docs/exported-services.mdx","fullPath":"/consul/api-docs/exported-services","id":"sidebar-nav-item-31"},{"title":"Health","path":"health","filePath":"../content/api-docs/health.mdx","fullPath":"/consul/api-docs/health","id":"sidebar-nav-item-32"},{"title":"KV Store","path":"kv","filePath":"../content/api-docs/kv.mdx","fullPath":"/consul/api-docs/kv","id":"sidebar-nav-item-33"},{"title":"Operator","routes":[{"title":"Overview","path":"operator","filePath":"../content/api-docs/operator/index.mdx","fullPath":"/consul/api-docs/operator","id":"sidebar-nav-item-35"},{"title":"Area","path":"operator/area","filePath":"../content/api-docs/operator/area.mdx","fullPath":"/consul/api-docs/operator/area","id":"sidebar-nav-item-36"},{"title":"Autopilot","path":"operator/autopilot","filePath":"../content/api-docs/operator/autopilot.mdx","fullPath":"/consul/api-docs/operator/autopilot","id":"sidebar-nav-item-37"},{"title":"Keyring","path":"operator/keyring","filePath":"../content/api-docs/operator/keyring.mdx","fullPath":"/consul/api-docs/operator/keyring","id":"sidebar-nav-item-38"},{"title":"License","path":"operator/license","filePath":"../content/api-docs/operator/license.mdx","fullPath":"/consul/api-docs/operator/license","id":"sidebar-nav-item-39"},{"title":"Raft","path":"operator/raft","filePath":"../content/api-docs/operator/raft.mdx","fullPath":"/consul/api-docs/operator/raft","id":"sidebar-nav-item-40"},{"title":"Segment","path":"operator/segment","filePath":"../content/api-docs/operator/segment.mdx","fullPath":"/consul/api-docs/operator/segment","id":"sidebar-nav-item-41"},{"title":"Usage","path":"operator/usage","filePath":"../content/api-docs/operator/usage.mdx","fullPath":"/consul/api-docs/operator/usage","id":"sidebar-nav-item-42"}],"id":"sidebar-nav-item-34"},{"title":"Namespaces","path":"namespaces","filePath":"../content/api-docs/namespaces.mdx","fullPath":"/consul/api-docs/namespaces","id":"sidebar-nav-item-43"},{"title":"Prepared Queries","path":"query","filePath":"../content/api-docs/query.mdx","fullPath":"/consul/api-docs/query","id":"sidebar-nav-item-44"},{"title":"Sessions","path":"session","filePath":"../content/api-docs/session.mdx","fullPath":"/consul/api-docs/session","id":"sidebar-nav-item-45"},{"title":"Snapshots","path":"snapshot","filePath":"../content/api-docs/snapshot.mdx","fullPath":"/consul/api-docs/snapshot","id":"sidebar-nav-item-46"},{"title":"Status","path":"status","filePath":"../content/api-docs/status.mdx","fullPath":"/consul/api-docs/status","id":"sidebar-nav-item-47"},{"title":"Transactions","path":"txn","filePath":"../content/api-docs/txn.mdx","fullPath":"/consul/api-docs/txn","id":"sidebar-nav-item-48"},{"divider":true,"id":"sidebar-nav-item-49"},{"title":"Libraries &amp; SDKs","path":"libraries-and-sdks","filePath":"../content/api-docs/libraries-and-sdks.mdx","fullPath":"/consul/api-docs/libraries-and-sdks","id":"sidebar-nav-item-50"}],"title":"API","visuallyHideTitle":true}],"mainWidth":"narrow","githubFileUrl":"https://github.com/hashicorp/consul/blob/main/website/../content/api-docs/features/blocking.mdx"},"metadata":{"title":"Blocking Queries","description":"Many endpoints in Consul support a feature known as \"blocking queries\". A\nblocking query is used to wait for a potential change using long polling.","layout":null},"outlineItems":[{"title":"Blocking Queries","url":"#blocking-queries"},{"title":"Implementation Details","url":"#implementation-details"},{"title":"Streaming backend","url":"#streaming-backend"},{"title":"Hash-based Blocking Queries","url":"#hash-based-blocking-queries"}],"pageHeading":{"id":"blocking-queries","title":"Blocking Queries"},"mdxSource":{"compiledSource":"const layoutProps={};const MDXLayout=\"wrapper\";function MDXContent({components,...props}){return mdx(MDXLayout,{...layoutProps,...props,components:components,mdxType:\"MDXLayout\"},mdx(\"p\",null,`Many endpoints in Consul support a feature known as \"blocking queries\". A\nblocking query is used to wait for a potential change using long polling. Not\nall endpoints support blocking, but each endpoint uniquely documents its support\nfor blocking queries in the documentation.`),mdx(\"p\",null,`Endpoints that support blocking queries return an HTTP header named\n`,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-Index`),`. This is a unique identifier representing the current state of\nthe requested resource.`),mdx(\"p\",null,`On subsequent requests for this resource, the client can set the `,mdx(\"inlineCode\",{parentName:\"p\"},`index`),` query\nstring parameter to the value of `,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-Index`),`, indicating that the client\nwishes to wait for any changes subsequent to that index.`),mdx(\"p\",null,`When this is provided, the HTTP request will \"hang\" until a change in the system\noccurs, or the maximum timeout is reached. A critical note is that the return of\na blocking request is `,mdx(\"strong\",{parentName:\"p\"},`no guarantee`),` of a change. It is possible that the\ntimeout was reached or that there was an idempotent write that does not affect\nthe result of the query.`),mdx(\"p\",null,`In addition to `,mdx(\"inlineCode\",{parentName:\"p\"},`index`),`, endpoints that support blocking will also honor a `,mdx(\"inlineCode\",{parentName:\"p\"},`wait`),`\nparameter specifying a maximum duration for the blocking request. This is\nlimited to 10 minutes. If not set, the wait time defaults to 5 minutes. This\nvalue can be specified in the form of \"10s\" or \"5m\" (i.e., 10 seconds or 5\nminutes, respectively). A small random amount of additional wait time is added\nto the supplied maximum `,mdx(\"inlineCode\",{parentName:\"p\"},`wait`),` time to spread out the wake up time of any\nconcurrent requests. This adds up to `,mdx(\"inlineCode\",{parentName:\"p\"},`wait / 16`),` additional time to the maximum\nduration.`),mdx(\"h2\",{\"id\":\"implementation-details\"},mdx(\"a\",{parentName:\"h2\",\"className\":\"__permalink-h\",\"href\":\"#implementation-details\",\"aria-label\":\"implementation details permalink\"},`\\xbb`),`Implementation Details`),mdx(\"p\",null,`While the mechanism is relatively simple to work with, there are a few edge\ncases that must be handled correctly.`),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},mdx(\"strong\",{parentName:\"p\"},`Reset the index if it goes backwards`),`. While indexes in general are\nmonotonically increasing(i.e. they should only ever increase as time passes),\nthere are several real-world scenarios in\nwhich they can go backwards for a given query. Implementations must check\nto see if a returned index is lower than the previous value,\nand if it is, should reset index to `,mdx(\"inlineCode\",{parentName:\"p\"},`0`),` - effectively restarting their blocking loop.\nFailure to do so may cause the client to miss future updates for an unbounded\ntime, or to use an invalid index value that causes no blocking and increases\nload on the servers. Cases where this can occur include:`),mdx(\"ul\",{parentName:\"li\"},mdx(\"li\",{parentName:\"ul\"},`If a raft snapshot is restored on the servers with older version of the data.`),mdx(\"li\",{parentName:\"ul\"},`KV list operations where an item with the highest index is removed.`),mdx(\"li\",{parentName:\"ul\"},`A Consul upgrade changes the way watches work to optimize them with more\ngranular indexes.`))),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},mdx(\"strong\",{parentName:\"p\"},`Sanity check index is greater than zero`),`. After the initial request (or a\nreset as above) the `,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-Index`),` returned `,mdx(\"em\",{parentName:\"p\"},`should`),` always be greater than zero. It\nis a bug in Consul if it is not, however this has happened a few times and can\nstill be triggered on some older Consul versions. It's especially bad because it\ncauses blocking clients that are not aware to enter a busy loop, using excessive\nclient CPU and causing high load on servers. It is `,mdx(\"em\",{parentName:\"p\"},`always`),` safe to use an\nindex of `,mdx(\"inlineCode\",{parentName:\"p\"},`1`),` to wait for updates when the data being requested doesn't exist\nyet, so clients `,mdx(\"em\",{parentName:\"p\"},`should`),` sanity check that their index is at least 1 after\neach blocking response is handled to be sure they actually block on the next\nrequest.`)),mdx(\"li\",{parentName:\"ul\"},mdx(\"p\",{parentName:\"li\"},mdx(\"strong\",{parentName:\"p\"},`Rate limit`),`. The blocking query mechanism is reasonably efficient when updates\nare relatively rare (order of tens of seconds to minutes between updates). In cases\nwhere a result gets updated very fast however - possibly during an outage or incident\nwith a badly behaved client - blocking query loops degrade into busy loops that\nconsume excessive client CPU and cause high server load. While it's possible to just add a sleep\nto every iteration of the loop, this is `,mdx(\"strong\",{parentName:\"p\"},`not`),` recommended since it causes update\ndelivery to be delayed in the happy case, and it can exacerbate the problem since\nit increases the chance that the index has changed on the next request. Clients\n`,mdx(\"em\",{parentName:\"p\"},`should`),` instead rate limit the loop so that in the happy case they proceed without\nwaiting, but when values start to churn quickly they degrade into polling at a\nreasonable rate (say every 15 seconds). Ideally this is done with an algorithm that\nallows a couple of quick successive deliveries before it starts to limit rate - a\n`,mdx(\"a\",{parentName:\"p\",\"href\":\"https://en.wikipedia.org/wiki/Token_bucket\"},`token bucket`),` with burst of 2 is a simple\nway to achieve this.`))),mdx(\"h2\",{\"id\":\"streaming-backend\"},mdx(\"a\",{parentName:\"h2\",\"className\":\"__permalink-h\",\"href\":\"#streaming-backend\",\"aria-label\":\"streaming backend permalink\"},`\\xbb`),`Streaming backend`),mdx(\"p\",null,`The streaming backend, first introduced in Consul 1.10, is a replacement for the long\npolling backend.  If streaming is supported by an endpoint, it will be used when either\nthe `,mdx(\"inlineCode\",{parentName:\"p\"},`index`),` or `,mdx(\"inlineCode\",{parentName:\"p\"},`cached`),` query parameters are set.`),mdx(\"p\",null,`When streaming is used, the Consul servers publish change events to a topic. Clients\nsubscribe to a topic to receive these change events. The clients use the change events to build\na local \"materialized view\". Clients are then able to handle requests using that view.\nStreaming improves on the traditional long polling between clients and servers\nby significantly reducing the quantity of data sent between them, while still allowing\nclients to handle read requests.`),mdx(\"p\",null,`While streaming is a significant optimization over long polling, it will not populate the\n`,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-LastContact`),` or `,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-KnownLeader`),` response headers, because the required\ndata is not available to the client.`),mdx(\"p\",null,`When the streaming backend is used, API responses will include the `,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-Query-Backend`),`\nheader with a value of `,mdx(\"inlineCode\",{parentName:\"p\"},`streaming`),`.`),mdx(\"h2\",{\"id\":\"hash-based-blocking-queries\"},mdx(\"a\",{parentName:\"h2\",\"className\":\"__permalink-h\",\"href\":\"#hash-based-blocking-queries\",\"aria-label\":\"hash based blocking queries permalink\"},`\\xbb`),`Hash-based Blocking Queries`),mdx(\"p\",null,`A limited number of agent endpoints also support blocking however because the\nstate is local to the agent and not managed with a consistent raft index, their\nblocking mechanism is different.`),mdx(\"p\",null,`Since there is no monotonically increasing index, each response instead contains\na header `,mdx(\"inlineCode\",{parentName:\"p\"},`X-Consul-ContentHash`),` which is an opaque hash digest generated by\nhashing over all fields in the response that are relevant.`),mdx(\"p\",null,`Subsequent requests may be sent with a query parameter `,mdx(\"inlineCode\",{parentName:\"p\"},`hash=<value>`),` where\n`,mdx(\"inlineCode\",{parentName:\"p\"},`value`),` is the last hash header value seen, and this will block until the `,mdx(\"inlineCode\",{parentName:\"p\"},`wait`),`\ntimeout is passed or until the local agent's state changes in such a way that\nthe hash would be different.`),mdx(\"p\",null,`Other than the different header and query parameter names, the biggest\ndifference is that hash values are opaque and can't be compared to see if one\nresult is older or newer than another. In general hash-based blocking will not\nreturn too early due to an idempotent update since the hash will remain the same\nunless the result actually changes, however as with index-based blocking there\nis no strict guarantee that clients will never observe the same result delivered\nbefore the full timeout has elapsed.`))};MDXContent.isMDXComponent=true;","scope":{"product":"consul","version":"latest"}},"product":{"name":"Consul","slug":"consul","algoliaConfig":{"indexName":"product_CONSUL","searchOnlyApiKey":"fbd5dc1f0078d41509fcc560386fd534"},"analyticsConfig":{"includedDomains":"consul.io www.consul.io","segmentWriteKey":"IyzLrqXkox5KJ8XL4fo8vTYNGfiKlTCm"},"datoToken":"88b4984480dad56295a8aadae6caad","metadata":{"title":"Consul by HashiCorp","description":"Consul is a service networking solution to automate network configurations, discover services, and enable secure connectivity across any cloud or runtime.","image":"https://www.consulproject.io/consul-public/img/og-image.png","icon":[{"href":"/consul-public/_favicon.ico"}]},"alertBannerActive":true,"alertBanner":{"tag":"HashiDays","url":"https://hashicorp.com/conferences/hashidays","text":"One conference. Three cities.","linkText":"Find a city near you","expirationDate":"2024-06-14T00:00:00-08:00"},"version":"1.11.3","subnavItems":[],"basePaths":["docs","api-docs","commands","downloads"],"rootDocsPaths":[{"iconName":"docs","name":"Documentation","path":"docs"},{"iconName":"api","name":"API","path":"api-docs"},{"iconName":"terminal-screen","name":"CLI","path":"commands"}],"currentRootDocsPath":{"iconName":"api","name":"API","path":"api-docs"}},"projectName":null,"versions":null},"__N_SSG":true}